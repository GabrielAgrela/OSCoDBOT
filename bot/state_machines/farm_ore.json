{
  "type": "graph",
  "start": "CooldownGate",
  "loop_sleep_s": 0.05,
  "steps": [
    {
      "name": "CooldownGate",
      "actions": [
        {
          "type": "CooldownGate",
          "name": "ore_cooldown_gate",
          "key": "ore"
        }
      ],
      "on_success": "CheckUnitsOverviewFull",
      "on_failure": "CooldownGate"
    },
    {
      "name": "CheckUnitsOverviewFull",
      "actions": [
        {
          "type": "Wait",
          "name": "wait_before_units_check",
          "seconds": 1.0,
          "randomize": true
        },
        {
          "type": "Screenshot",
          "name": "ore_cap_units_overview"
        },
        {
          "type": "CheckTemplatesCountAtLeast",
          "name": "UnitsOverviewIcons",
          "templates": [
            "MiningIcon.png",
            "GoingIcon.png",
            "ReturningIcon.png",
            "BuildingIcon.png",
            "StillIcon.png"
          ],
          "region_pct": {
            "$config": "units_overview_region_pct"
          },
          "threshold": {
            "$config": "match_threshold"
          },
          "min_total": {
            "$config": "max_armies",
            "default": 3
          },
          "verify_threshold": {
            "$config": "verify_threshold"
          }
        }
      ],
      "on_success": "CooldownAndEnd",
      "on_failure": "CloseActionsMenu"
    },
    {
      "name": "CloseActionsMenu",
      "actions": [
        {
          "type": "Screenshot",
          "name": "ore_cap_actions_close"
        },
        {
          "type": "FindAndClick",
          "name": "ActionsMenuClose",
          "templates": [
            "ActionMenuClose.png"
          ],
          "region_pct": {
            "$config": "action_menu_close_region_pct"
          },
          "threshold": {
            "$config": "match_threshold"
          },
          "verify_threshold": 0.8
        },
        {
          "type": "Wait",
          "name": "wait_after_actions_close",
          "seconds": 0.3,
          "randomize": true
        }
      ],
      "on_success": "OpenMagnifier",
      "on_failure": "OpenMagnifier"
    },
    {
      "name": "OpenMagnifier",
      "actions": [
        {
          "type": "Wait",
          "name": "wait_before_screenshot",
          "seconds": 2.0,
          "randomize": true
        },
        {
          "type": "Screenshot",
          "name": "ore_cap_open_1"
        },
        {
          "type": "FindAndClick",
          "name": "Magnifier",
          "templates": [
            "Magnifier.png"
          ],
          "region_pct": {
            "$config": "magifier_region_pct"
          },
          "threshold": {
            "$config": "match_threshold"
          },
          "verify_threshold": {
            "$config": "verify_threshold"
          }
        },
        {
          "type": "Wait",
          "name": "wait_after_magnifier",
          "seconds": 1.0,
          "randomize": true
        }
      ],
      "on_success": "OreAny",
      "on_failure": "ClickMapIcon"
    },
    {
      "name": "ClickMapIcon",
      "actions": [
        {
          "type": "Screenshot",
          "name": "ore_cap_map_1"
        },
        {
          "type": "FindAndClick",
          "name": "MapIcon",
          "templates": [
            "MapIcon.png"
          ],
          "region_pct": {
            "$config": "magifier_region_pct"
          },
          "threshold": {
            "$config": "match_threshold"
          },
          "verify_threshold": {
            "$config": "verify_threshold"
          }
        },
        {
          "type": "Wait",
          "name": "wait_after_map",
          "seconds": 1.0,
          "randomize": true
        }
      ],
      "on_success": "MagnifierAfterMap",
      "on_failure": "MagnifierAfterMap"
    },
    {
      "name": "MagnifierAfterMap",
      "actions": [
        {
          "type": "Screenshot",
          "name": "ore_cap_open_2"
        },
        {
          "type": "FindAndClick",
          "name": "MagnifierAgain",
          "templates": [
            "Magnifier.png"
          ],
          "region_pct": {
            "$config": "magifier_region_pct"
          },
          "threshold": {
            "$config": "match_threshold"
          },
          "verify_threshold": {
            "$config": "verify_threshold"
          }
        },
        {
          "type": "Wait",
          "name": "wait_after_magnifier2",
          "seconds": 1.0,
          "randomize": true
        }
      ],
      "on_success": "OreAny",
      "on_failure": "EndNoLegions"
    },
    {
      "name": "OreAny",
      "actions": [
        {
          "type": "Screenshot",
          "name": "ore_cap_res_1"
        },
        {
          "type": "FindAndClick",
          "name": "OreAny",
          "templates": [
            "OreMine.png",
            "OreMineEnabled.png"
          ],
          "region_pct": {
            "$config": "resource_search_selection_region_pct"
          },
          "threshold": {
            "$config": "match_threshold"
          },
          "verify_threshold": {
            "$config": "verify_threshold"
          }
        },
        {
          "type": "Wait",
          "name": "wait_after_ore",
          "seconds": 1.0,
          "randomize": true
        }
      ],
      "on_success": "SearchFarmButton",
      "on_failure": "EndNoLegions"
    },
    {
      "name": "SearchFarmButton",
      "actions": [
        {
          "type": "Retry",
          "name": "SearchFarmButtonRetry",
          "actions": [
            {
              "type": "Screenshot",
              "name": "ore_cap_search_1"
            },
            {
              "type": "FindAndClick",
              "name": "SearchFarmButton",
              "templates": [
                "SearchFarmButton.png"
              ],
              "region_pct": {
                "$config": "resource_search_button_region_pct"
              },
              "threshold": {
                "$config": "match_threshold"
              },
              "verify_threshold": {
                "$config": "verify_threshold"
              }
            },
            {
              "type": "Wait",
              "name": "wait_after_search",
              "seconds": 2.0,
              "randomize": true
            }
          ],
          "attempts": 3
        }
      ],
      "on_success": "GatherButton",
      "on_failure": "EndNoLegions"
    },
    {
      "name": "GatherButton",
      "actions": [
        {
          "type": "Screenshot",
          "name": "ore_cap_gather_1"
        },
        {
          "type": "FindAndClick",
          "name": "GatherButton",
          "templates": [
            "GatherButton.png"
          ],
          "region_pct": {
            "$config": "gather_button_region_pct"
          },
          "threshold": {
            "$config": "match_threshold"
          },
          "verify_threshold": {
            "$config": "verify_threshold"
          }
        },
        {
          "type": "Wait",
          "name": "wait_after_gather",
          "seconds": 1.0,
          "randomize": true
        }
      ],
      "on_success": "CreateLegionsButton",
      "on_failure": "TapCenterThenGather"
    },
    {
      "name": "CooldownAndEnd",
      "actions": [
        {
          "type": "SetCooldownRandom",
          "name": "ore_set_cooldown",
          "key": "ore",
          "min_seconds": {
            "$config": "farm_cooldown_min_s",
            "default": 300
          },
          "max_seconds": {
            "$config": "farm_cooldown_max_s",
            "default": 3600
          }
        }
      ],
      "on_success": "CooldownGate",
      "on_failure": "CooldownGate"
    },
    {
      "name": "TapCenterThenGather",
      "actions": [
        {
          "type": "ClickPercent",
          "name": "tap_center",
          "x_pct": 0.5,
          "y_pct": 0.5
        },
        {
          "type": "Wait",
          "name": "wait_after_tap_center",
          "seconds": 1.0,
          "randomize": true
        },
        {
          "type": "Screenshot",
          "name": "ore_cap_gather_retry"
        },
        {
          "type": "FindAndClick",
          "name": "GatherButtonRetry",
          "templates": [
            "GatherButton.png"
          ],
          "region_pct": {
            "$config": "gather_button_region_pct"
          },
          "threshold": {
            "$config": "match_threshold"
          },
          "verify_threshold": {
            "$config": "verify_threshold"
          }
        },
        {
          "type": "Wait",
          "name": "wait_after_gather_retry",
          "seconds": 1.0,
          "randomize": true
        }
      ],
      "on_success": "CreateLegionsButton",
      "on_failure": "EndNoLegions"
    },
    {
      "name": "CreateLegionsButton",
      "actions": [
        {
          "type": "Screenshot",
          "name": "ore_cap_legions_1"
        },
        {
          "type": "FindAndClick",
          "name": "CreateLegionsButton",
          "templates": [
            "CreateLegionsButton.png"
          ],
          "region_pct": {
            "$config": "create_legions_button_region_pct"
          },
          "threshold": {
            "$config": "match_threshold"
          },
          "verify_threshold": {
            "$config": "verify_threshold"
          }
        },
        {
          "type": "Wait",
          "name": "wait_after_legions",
          "seconds": 1.0,
          "randomize": true
        }
      ],
      "on_success": "RemoveCommander",
      "on_failure": "EndNoLegions"
    },
    {
      "name": "EndNoLegions",
      "actions": [
        {
          "type": "ClickPercent",
          "name": "tap_center_end",
          "x_pct": 0.5,
          "y_pct": 0.7
        },
        {
          "type": "Wait",
          "name": "wait_after_end_click",
          "seconds": 1.0,
          "randomize": true
        },
        {
          "type": "EndCycle",
          "name": "end_cycle"
        }
      ],
      "on_success": "CooldownGate",
      "on_failure": "CooldownGate"
    },
    {
      "name": "RemoveCommander",
      "actions": [
        {
          "type": "Screenshot",
          "name": "ore_cap_remove_commander"
        },
        {
          "type": "FindAndClick",
          "name": "RemoveCommanderButton",
          "templates": [
            "RemoveCommanderButton.png"
          ],
          "region_pct": [
            0.0,
            0.0,
            1.0,
            1.0
          ],
          "threshold": {
            "$config": "match_threshold"
          },
          "verify_threshold": {
            "$config": "verify_threshold"
          }
        },
        {
          "type": "Wait",
          "name": "wait_after_remove_commander",
          "seconds": 0.5,
          "randomize": true
        }
      ],
      "on_success": "March",
      "on_failure": "March"
    },
    {
      "name": "March",
      "actions": [
        {
          "type": "Screenshot",
          "name": "ore_cap_march_1"
        },
        {
          "type": "FindAndClick",
          "name": "March",
          "templates": [
            "March.png"
          ],
          "region_pct": {
            "$config": "march_button_region_pct"
          },
          "threshold": {
            "$config": "match_threshold"
          },
          "verify_threshold": {
            "$config": "verify_threshold"
          }
        },
        {
          "type": "Wait",
          "name": "wait_after_march",
          "seconds": 1.0,
          "randomize": true
        }
      ],
      "on_success": "End",
      "on_failure": "EndNoLegions"
    },
    {
      "name": "End",
      "actions": [
        {
          "type": "EndCycle",
          "name": "end_cycle"
        }
      ],
      "on_success": "CooldownGate",
      "on_failure": "CooldownGate"
    }
  ],
  "key": "farm_ore",
  "label": "Farm Ore",
  "metadata": {
    "category": "Primary Farming",
    "badge": "Loop",
    "description": "Targets ore deposits, downgrades search level when needed, and handles gather and march flows.",
    "tags": [
      "farm",
      "ore",
      "gather"
    ]
  },
  "context": "default"
}
